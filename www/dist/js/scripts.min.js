var Average=function(){arr=[],this.add=function(r){if(Array.isArray(r)){for(var a in r)arr.push(r[a]);return this.average()}return arr.push(r),this.average()},this.shift=function(){return arr.shift(),this.average()},this.average=function(r){var a=0;for(i=r&&arr.length-r>=0?arr.length-r:0;i<arr.length;i++)a+=arr[i]||0;return a/(r&&r<=arr.length?r:arr.length)}};
var Spotify=function(t){var e="undefined"!=typeof jQuery?!0:!1,o=4371,n="",r=!1,s=function(t,n){var r=function(){return Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,10)+"."};if(e){var s={url:"https://"+r()+"spotilocal.com:"+o+t,error:function(t,e){n&&n(e)},success:function(t){var e=t;n&&n(e)}};$.get(s)}else{var u=new XMLHttpRequest;u.open("GET","https://"+r()+"spotilocal.com:"+o+t,!0),u.onload=function(){if(u.status>=200&&u.status<400){var t=JSON.parse(u.responseText);n&&n(t)}else n&&n("error")},u.onerror=function(){n&&n("error")},u.send()}};this.ready=function i(u){return r?(u&&u(),!0):void s("/service/version.json?service=remote",function(f){if("error"===f&&4380>o)o+=1,i(u);else if("error"===f&&o>=4380)u&&u("Spotify application is not running or doesn't support the internal web server.");else if(e)$.ajax({url:"https://jsonp.afeld.me/?url=https://open.spotify.com/token",method:"GET",success:function(e){n=e.t,s("/remote/status.json?csrf="+t+"&oauth="+n+"&returnon=login%2Clogout%2Cplay%2Cpause%2Cerror%2Cap&returnafter=1",function(t){"undefined"!=typeof t.error&&"4107"===t.error.type?(o+=1,i(u)):"undefined"!=typeof t.error&&"4107"===t.error.type&&o>=4380?u&&u("invalid CSRF token"):(u&&u(),r=!0)})}});else{var a=new XMLHttpRequest;a.open("GET","https://jsonp.afeld.me/?url=https://open.spotify.com/token",!0),a.onload=function(){if(a.status>=200&&a.status<400){var e=JSON.parse(a.responseText);n=e.t,s("/remote/status.json?csrf="+t+"&oauth="+n,function(t){"undefined"!=typeof t.error&&"4107"===t.error.type?u&&u("invalid CSRF token"):(u&&u(),r=!0)})}else u&&u("error")},a.onerror=function(){u&&u("error")},a.send()}})},this.status=function(e,o,r){"function"==typeof e&&(r=e,e=void 0),"function"==typeof o&&(r=o,o=void 0),s("/remote/status.json?csrf="+t+"&oauth="+n+(e?"&returnon="+e:"")+(o?"&returnafter="+o:""),function(t){r&&r(t)})},this.play=function(e,o,r){e&&"string"==typeof e?s("/remote/play.json?csrf="+t+"&oauth="+n+"&uri="+encodeURIComponent(e+(o?"#"+o:"")),function(t){r&&r(t)}):s("/remote/pause.json?csrf="+t+"&oauth="+n+"&pause=false",function(t){(r||"function"==typeof e)&&(r=e)(t)})},this.toggle=function(e){this.status(function(o){s("/remote/pause.json?csrf="+t+"&oauth="+n+"&pause="+o.playing,function(t){e&&e(t)})})},this.pause=function(e){s("/remote/pause.json?csrf="+t+"&oauth="+n+"&pause=true",function(t){e&&e(t)})};var u={};this.on=function f(e,o,r){var i=!1;window.onbeforeunload=function(){i=!0},"function"==typeof o&&(r=o,o=void 0),r&&(u[e]=r),r||delete u[e],s("/remote/status.json?csrf="+t+"&oauth="+n+"&returnon="+e+(o?"&returnafter="+o:"&returnafter=0"),function(t){u[e]&&!i&&(u[e](t),f(e,o,u[e]))})}};
function addScript(t){var e=document.createElement("script");e.type="text/javascript",e.src=t,document.body.appendChild(e)}
var query=function(){var e={};if(window.location.href.split("?").length<=1)return e;var o=window.location.href.split("?")[1],r=o.split("&");for(var n in r){var i=r[n].split("=");e[i[0]]=i[1]}return e}();query.code&&$.ajax({url:"/token?code="+query.code,success:function(e){var o=JSON.parse(e);window.localStorage.setItem("refresh_token",o.refresh_token),window.location.replace(window.location.origin)}});
var prev,cards={show:function(t,s,e){function i(){$(".card").filter(function(){return $(this).offset().top==$(".card").filter(function(){return"0"==$(this).css("opacity")}).offset().top}).removeAttr("style").fadeIn().animateCss("flipInX"),$(".card").filter(function(){return"0"==$(this).css("opacity")}).length>0?setTimeout(function(){i()},60):e&&e()}if("function"==typeof t&&(e=t),"function"==typeof s&&(e=s),s&&"function"!=typeof s){var n={id:{text:function(t){return this.id}},display_name:{text:function(t){return null!==this.display_name?this.display_name:""}},icon:{src:function(t){return this.images.length>=1?this.images[0].url:void 0}},card:{"data-id":function(t){return this.socket_id}}};_.isEqual(prev,s)||(t?cards.hide(!0,function(){return null===s||0===s.length?$(".nav-link.friends").hasClass("active")?$(".no-users").find("h1").text("No friends are currently streaming").parent().show():$(".no-users").find("h1").text("No users are currently streaming").parent().show():($(".users").render(s,n),$(".card").show(),$(".card").css("opacity",1),void 0)}):cards.hide(!1,function(){return null===s||0===s.length?$(".nav-link.friends").hasClass("active")?$(".no-users").find("h1").text("No friends are currently streaming").parent().fadeIn():$(".no-users").find("h1").text("No users are currently streaming").parent().fadeIn():($(".users").render(s,n),cards.hide(!0),i(),void 0)}),prev=s)}$("img.card-img").hover(function(){socket.emit("status",$(this).parent().parent().attr("data-id")),$(this).stop().animate({opacity:0},400),$(".stream-sm").hasClass("pulse")||$(this).parent().parent().find(".overlay").stop().fadeIn(),$(this).parent().find(".song_name").stop().fadeIn(function(){$(this).marquee()})},function(){$(this).stop().animate({opacity:1},400),$(this).parent().parent().find(".overlay").stop().fadeOut(),$(this).parent().find(".song_name").stop().animate({scrollLeft:0},0).fadeOut(function(){$(this).css("opacity",1)}).css("opacity",0)}),$("img.icon").click(function(){if($(".stream-sm").hasClass("pulse"))alert("You can't listen to other streams while streaming!");else if(""!==play.user_id&&$(this).closest("div.user").prop("data-id")!==play.user_id)alert("You can't listen to two streams at once!");else{var t=this;$(this).closest("div.user").find("i.fa").hasClass("fa-play")?play.user($(this).closest("div.user").prop("data-id"),function(s){console.log(s),$(t).closest("div.user").find("i.fa.fa-play:visible").fadeOut(function(){$(this).removeClass("fa-play").addClass("fa-pause").fadeIn()})}):(play.user(),$(t).closest("div.user").find("i.fa.fa-pause:visible").fadeOut(function(){$(this).removeClass("fa-pause").addClass("fa-play").fadeIn()}),spotify.pause())}})},hide:function(t,s){t?($(".no-users").hide(),$(".card").css("opacity",0),$(".card").hide(),s&&s()):($(".no-users:visible").fadeOut(function(){s&&s()}),$(".card:visible").fadeOut(function(){$(this).css("opacity",0),s&&s()}),$(".no-users").is(":visible")||$(".card").is(":visible")||s&&s())}};$.fn.extend({animateCss:function(t,s){var e="webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend";$(this).addClass("animated "+t).one(e,function(){$(this).removeClass("animated "+t),s&&s()})}});
function modalCsrf(){$(".modal-csrf").on("paste keyup",function(e){if(8!==e.keyCode&&""!==$(".modal-csrf").val()){var t=$(".modal-csrf").val();spotify=new Spotify(t),spotify.ready(function(e){e?(console.log(e),$(".modal-csrf").parent().parent().addClass("has-error"),$(".modal-csrf").animateCss("shake")):($(".modal").modal("hide"),$(".modal-csrf").parent().parent().removeClass("has-error"),window.localStorage.setItem("csrf",t),null!==window.localStorage.getItem("refresh_token")?$.ajax({url:"/refresh?refresh_token="+window.localStorage.getItem("refresh_token"),success:function(e){var t=JSON.parse(e);$.ajax({url:"https://api.spotify.com/v1/me",headers:{Authorization:"Bearer "+t.access_token},success:function(e){$(".csrftut").fadeOut(),$(".csrf").fadeOut(function(){$(".main").fadeIn(),$("body").removeAttr("style").css("padding-bottom",$(".navbar-fixed-bottom").height()+18).css("padding-top",$(".navbar-fixed-top").height()+30),cards.show()}),console.log(e)}})}}):"Sign In:"!==$(".form-control-label").text()&&($(".csrftut").fadeOut(),$("#csrf").animate({width:"hide"},function(){$(".auth").animate({width:"show"},function(){$(".form-control-label").fadeOut(function(){$(this).text("Sign In:").fadeIn()}),$(".auth").mousedown(function(e){window.location.replace("/login")})})})))})}})}var me={},spotify={};$(document).ready(function(){if(null===window.localStorage.getItem("csrf")||null===window.localStorage.getItem("refresh_token")?$(document).ready(function(){$(".csrf").fadeIn(),$("#csrf").focus()}):(cards.hide(!0),$(".main").fadeIn(),$("body").scrollTop(0)),null!==window.localStorage.getItem("refresh_token")&&$.ajax({url:"/refresh?refresh_token="+window.localStorage.getItem("refresh_token"),success:function(e){var t=JSON.parse(e);socket(t.access_token,function(){$.ajax({url:"https://api.spotify.com/v1/me",headers:{Authorization:"Bearer "+t.access_token},success:function(e){me=e,e.images.length>=1&&$(".user-icon").fadeOut(function(){$(".user-icon").attr("src",e.images[0].url).fadeIn()})}})})}}),query.csrf||null!==window.localStorage.getItem("csrf")){$("#csrf").hide(),$(".csrftut").hide(),$(".form-control-label").hide(),$(".auth").fadeIn(),$(".form-control-label").text("Sign In:").fadeIn(),$(".auth").mousedown(function(e){window.location.replace("/login")});var e=null!==window.localStorage.getItem("csrf")?window.localStorage.getItem("csrf"):query.csrf;spotify=new Spotify(e),spotify.ready(function(t){t?(console.log(t),$(".auth").animate({width:"hide"},function(){$("#csrf").animate({width:"show"},function(){$(".csrftut").fadeIn(),$(".form-control-label").fadeOut(function(){$(this).text("CSRF:").fadeIn()})})})):(window.localStorage.setItem("csrf",e),null!==window.localStorage.getItem("refresh_token")?($(".csrf").fadeOut(),$(".main").fadeIn(),null!==window.sessionStorage.getItem("streaming")&&$(".nav-link.stream").click()):"Sign In:"!==$(".form-control-label").text()&&$("#csrf").animate({width:"hide"},function(){$(".csrftut").fadeOut(),$(".auth").animate({width:"show"},function(){$(".form-control-label").fadeOut(function(){$(this).text("Sign In:").fadeIn()}),$(".auth").mousedown(function(e){window.location.replace("/login")})})}))})}$("#csrf").on("paste keyup",function(e){if(8!==e.keyCode&&""!==$("#csrf").val()){var t=$("#csrf").val();spotify=new Spotify(t),spotify.ready(function(e){e?(console.log(e),$("#csrf").parent().parent().addClass("has-error"),$("#csrf").animateCss("shake")):($("#csrf").parent().parent().removeClass("has-error"),window.localStorage.setItem("csrf",t),null!==window.localStorage.getItem("refresh_token")?$.ajax({url:"/refresh?refresh_token="+window.localStorage.getItem("refresh_token"),success:function(e){var t=JSON.parse(e);$.ajax({url:"https://api.spotify.com/v1/me",headers:{Authorization:"Bearer "+t.access_token},success:function(e){$(".csrftut").fadeOut(),$(".csrf").fadeOut(function(){$(".main").fadeIn(),$("body").removeAttr("style").css("padding-bottom",$(".navbar-fixed-bottom").height()+18).css("padding-top",$(".navbar-fixed-top").height()+30),cards.show()}),console.log(e)}})}}):"Sign In:"!==$(".form-control-label").text()&&($(".csrftut").fadeOut(),$("#csrf").animate({width:"hide"},function(){$(".auth").animate({width:"show"},function(){$(".form-control-label").fadeOut(function(){$(this).text("Sign In:").fadeIn()}),$(".auth").mousedown(function(e){window.location.replace("/login")})})})))})}})});
$(document).ready(function(){$("body").removeAttr("style").css("padding-bottom",$(".navbar-fixed-bottom").height()+18).css("padding-top",$(".navbar-fixed-top").height()+30),$(window).resize(function(){$("body").removeAttr("style").css("padding-bottom",$(".navbar-fixed-bottom").height()+18).css("padding-top",$(".navbar-fixed-top").height()+30)}),$(".user-icon").hover(function(){$(".user-icon-dropdown").stop().fadeIn()},function(){$(".user-icon-dropdown").stop().fadeOut()}),$(".logout").click(function(){window.localStorage.removeItem("refresh_token"),window.location.reload()}),$(".nav-link:not(.stream)").click(function(){$(this).hasClass("friends")?window.sessionStorage.setItem("tab","friends"):window.sessionStorage.setItem("tab","explore"),$(".nav-link").removeClass("active"),$(this).addClass("active");socket.emit("users")}),$(".dropdown").on("show.bs.dropdown",function(e){$("h6.username").text(me.display_name?me.display_name:me.id),$(this).find(".dropdown-menu").first().stop(!0,!0).slideDown()}),$(".dropdown").on("hide.bs.dropdown",function(e){$(this).find(".dropdown-menu").first().stop(!0,!0).slideUp()}),$(".nav-link.stream").click(function(){$(".stream-sm").hasClass("pulse")?(window.sessionStorage.removeItem("streaming"),$(".stream-sm").removeClass("pulse"),socket.emit("update","false"),spotify.on("play")):""!==play.user_id?alert("You can't stream while listening to a stream!"):spotify.status(function(e){e.playing?(window.sessionStorage.setItem("streaming",!0),$(".stream-sm").addClass("pulse"),e.from=play.time(),socket.emit("update",e),spotify.on("play, pause",function(e){e.playing||(confirm("Pausing will stop your stream.")?($(".stream-sm").removeClass("pulse"),socket.emit("update","false"),spotify.on("play")):spotify.play())})):alert("You must be playing music to start streaming!")})}),$("input.search-value").keyup(function(){search($("input.search-value").val()),$(".nav-link").removeClass("active"),window.sessionStorage.removeItem("tab")})});
$.fn.marquee=function(){function t(n,i){$(n).stop().animate({scrollLeft:i-190},10*i,function(){setTimeout(function(){$(n).animate({scrollLeft:0},5*i,function(){setTimeout(function(){t(n,i)})})},500)})}var n=$(this).html();$(this).html("<span>"+n+"</span>");var i=$(this).find("span:first").width();$(this).html(n),t(this,i)};
var interval,amountOff=new Average,play={user_id:"",format:function(t,o,i){if(o){var a=(play.time()-o)/1e3;return t+=a,"ceil"===i&&(t=Math.ceil(t)),"round"===i&&(t=Math.round(t)),"floor"===i&&(t=Math.floor(t)),Math.floor(t/60)+":"+"0".substring(0,2-JSON.stringify(t%60).split(".")[0].length)+t%60}return Math.floor(t/60)+":"+"0".substring(0,2-JSON.stringify(t%60).split(".")[0].length)+t%60},time:function(){return(new Date).getTime()},user:function(t,o){return t?void socket.emit("status",t,function(i){play.user_id=i[0].socket_id;var a=Math.abs(1e3-1e3*amountOff.average(5)-+(i[0].playing_position+(play.time()-i[0].from)/1e3)%1*1e3);setTimeout(function(){spotify.play(i[0].track.uri,play.format(i[0].playing_position,i[0].from,"floor"),function(i){o&&spotify.status(function(t){o(t)}),spotify.on("login,logout,play,pause,ap",3,function(i){socket.emit("status",t,function(t){play.playing(t[0].track.uri,t[0].playing_position,t[0].from,function(t){t||(spotify.on("login,logout,play,pause,ap"),play.user(play.user_id,o))})})})})},a)}):void(play.user_id="")},track:function(t,o,i){var a=Math.abs(1e3-1e3*amountOff.average(5)-+o.toString().split(".")[o.toString().split(".").length-1]);setTimeout(function(){spotify.on("login,logout,play,pause,ap",function(i){play.playing(t,o,play.time()),spotify.on("login,logout,play,pause,ap")}),spotify.play(t,play.format(o,play.time(),"floor"),function(t){i&&spotify.status(function(t){i(t)})})},a)},playing:function(t,o,i,a){spotify.status(function(n){return n.playing===!1&&a?a(!1):(console.log("streamer time: "+o+(play.time()-i)/1e3),console.log("user time: "+n.playing_position),console.log("amount off: "+Math.abs(n.playing_position-(o+(play.time()-i)/1e3-1))),amountOff.add(2*Math.abs(n.playing_position-(o+(play.time()-i)/1e3-1))),console.log("average amount off: "+amountOff.average(5)),void(n.track.track_resource.uri===t&&Math.abs(n.playing_position-(o+(play.time()-i)/1e3-1))<.05?a&&a(!0):a&&a(!1)))})}};
var prevApplicable=[],search=function(s,e){var r=[];for(var a in usrs)(usrs[a].display_name&&usrs[a].display_name.toLowerCase().indexOf(s)>-1||usrs[a].id.toLowerCase().indexOf(s)>-1)&&r.push(usrs[a]);_.isEqual(r,prevApplicable)||(r.length>0?cards.show(!1,r,function(){e&&e()}):cards.hide(!1)),prevApplicable=r};
var usrs=[],socket=function(t,s){socket=io("/",{query:"access_token="+t}),cards.hide(!0),null!==window.sessionStorage.getItem("tab")&&$(".nav-link."+window.sessionStorage.getItem("tab")).click(),socket.emit("users"),socket.on("users",function(s){if(!s)return socket.emit("users");if(usrs=s,0===$("img.icon").filter(function(){return $(this).is(":hover")}).length)if($(".nav-link.friends").hasClass("active")&&s.length>0){var e="";for(var o in s)e+=s[o].id+",";e=e.slice(0,-1),$.ajax({url:"https://api.spotify.com/v1/me/following/contains?type=user&ids="+e,headers:{Authorization:"Bearer "+t},success:function(t){for(var e=s.concat(t),o=[],i=s.length;i<e.length;i++)e[i]&&o.push(e[i-s.length]);$("html, body").stop().animate({scrollTop:0},"500","swing"),cards.show(!1,o)},error:function(t,s,e){$("html, body").stop().animate({scrollTop:0},"500","swing"),cards.show(!1,[])}})}else $("html, body").stop().animate({scrollTop:0},"500","swing"),cards.show(!1,s)}),socket.on("status",function(t){$.ajax({url:"https://api.spotify.com/v1/tracks/"+t[0].track.uri.replace("spotify:track:",""),success:function(s){$('[data-id="'+t[0].socket_id+'"]').find("div.card-img-bg").css("background","linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('"+s.album.images[1].url+"')")}}),$('[data-id="'+t[0].socket_id+'"]').find(".song_name").text()!==t[0].track.name&&$('[data-id="'+t[0].socket_id+'"]').find(".song_name").text(t[0].track.name)}),socket.on("update",function(t){spotify.ready()&&spotify.status(function(s){s.from=play.time(),socket.emit("update",s),t&&t("/#"+socket.id)})}),socket.on("connection",function(t){socket.emit("users")}),socket.on("disconnect",function(){socket.emit("users")}),s()};
//# sourceMappingURL=scripts.min.js.map
